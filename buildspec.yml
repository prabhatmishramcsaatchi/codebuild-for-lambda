version: 0.2

phases:
  install:
    commands:
      - echo "Pulling Lambda Python 3.11 image..."
      - docker pull public.ecr.aws/lambda/python:3.11
      
  build:
    commands:
      - echo "Creating directory structure..."
      - mkdir -p python
      
      - echo "Installing packages in Lambda environment with entrypoint override..."
      - |
        docker run --rm \
          --entrypoint /bin/sh \
          -v "$PWD":/var/task \
          public.ecr.aws/lambda/python:3.11 \
          -c "pip install --target /var/task/python paramiko"
      
      - echo "Creating zip file..."
      - zip -r python.zip python/
      
      - echo "Verifying zip was created..."
      - ls -lh python.zip
      
  post_build:
    commands:
      - echo "Uploading to S3..."
      - aws s3 cp python.zip s3://fluency-ccs-co-gsc-planning-and-evaluation-tool-uk/hootsuit_library/python.zip
      - echo "Upload complete!"
      
artifacts:
  files:
    - python.zip
